#include <unistd.h>
#include <sys/syscall.h>

#include "dangless/common.h"
#include "dangless/common/ppmap.h"
#include "dangless/syscallmeta.h"

// dangless/build/syscallmeta.inc is generated by scripts/generate_syscall_metadata.py

static int g_syscall_ptr_params[][SYSCALL_MAX_NUM_ARGS + 1] = {
  #define SYSCALL_USERPTR_PARAMS(NAME, ...) \
    [__NR_##NAME] = { __VA_ARGS__ },

  #include "dangless/build/syscallmeta.inc"
};

const int *syscall_get_userptr_params(index_t syscallno) {
  if (syscallno >= ARRAY_LENGTH(g_syscall_ptr_params)
      || g_syscall_ptr_params[syscallno][0] == 0)
    return NULL;

  return g_syscall_ptr_params[syscallno];
}

// TODO: don't generate this array unless we really need it for debug
static struct syscall_info g_syscall_infos[] = {
  #define SYSCALL_SIGNATURE(RETTY, NAME, NUM_PARAMS, ...) \
    [__NR_##NAME] = { \
      #NAME, \
      #RETTY, \
      NUM_PARAMS, \
      /*param_types=*/ { MAP_LIST(STRINGIFY, __VA_ARGS__) }, \
      /*signature=*/ #RETTY " " #NAME " (" #__VA_ARGS__ ")" \
    },

  #include "dangless/build/syscallmeta.inc"
};

const struct syscall_info *syscall_get_info(index_t syscallno) {
  if (syscallno >= ARRAY_LENGTH(g_syscall_infos)
      || !g_syscall_infos[syscallno].name)
    return NULL;

  return &g_syscall_infos[syscallno];
}
